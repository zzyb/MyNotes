# 并发

## 什么是线程

如果**一个程序**可以**同时**运行**<u>多个线程</u>**，则称这个程序是`多线程`的（multithreaded）。



`多线程` & 多进程

- 本质区别在于每个进程都拥有一套变量，而**线程则共享数据**。



**单独线程运行任务的简单过程**：

1. 将代码放入一个类的run方法中，这个类要实现Runnable接口。
   - Runnable接口只有一个方法：void run() 。
   - 由于Runnable是一个函数式接口，可以用一个lambda表达式创建一个实例。
     - `Runnable r = () -> { task code }`
2. 通过Runnable 构造一个Thread对象。
3. 启动线程。

```java

```



```java

```



```java

```



还可以通过 建立一个Thread类的一个子类来定义线程。（不推荐！！！）

1. 创建Thread的一个子类，实现run方法。
2. 构造子类对象，并调用start方法，启动。







<u>不要直接调用Thread或Runnable接口的run方法</u>。**应该调用Thread.start方法**。



## 线程状态

### 线程有6种状态。

1. New（新建）
2. Runnable（可运行）
3. Blocked（阻塞）
4. Waiting（等待）
5. Timed wating（计时等待）
6. Terminated（终止）



**通过`getState`方法确定一个线程的当前状态。**



- 新建线程

  当使用new操作符创建一个线程时，如new Thread(r)。这个线程还没有开始运行，它的状态是`新建（New）`

- 可运行线程

  调用start方法，线程就处于**可运行**状态。

  一个可运行状态的线程可能正在运行也可能没有运行。（由操作系统为线程提供具体的运行时间）

  一旦一个线程开始运行，它不一定始终保持运行。

- 阻塞和等待线程

  它暂时不是活动的。不运行任何代码，消耗最少的资源。（要由线程调度器重新激活这个线程）

  1. 当一个线程试图获取一个内部的对象锁，锁目前被其它线程占有，线程就会被阻塞。
  2. 当一个线程等待另一个线程通知调度器出现一个条件时，这个线程就会进入等待状态。
     - 阻塞和等待没有多大区别。
  3. 有几个方法有超时参数，调用这些方法会让线程进入计时等待。这一状态将一直保持到超时期满或者接收到适当通知。





### 线程状态转换图



![image-20210806205919156](./java并发.resource/线程状态转换图.jpg)

### 终止线程

- run方法正常退出。
- 因为一个没有捕获的异常终止了run方法，使线程意外终止。

能够通过`stop方法`杀死一个线程。该方法抛出一个ThreadDeath错误对象，这会杀死线程。（stop已废弃，不要使用！！！）



## 线程属性

### 中断线程

<u>终止线程的三个途径</u>：

1. run方法执行方法体中最后一条语句后在执行return返回时。
2. 出现了方法中没有捕获的异常时。
3. （**已废弃**）stop方法：其它线程调用这个方法来终止一个线程。



除了已废弃的stop方法，没有办法可以**强制**线程终止。

**interrupt方法**：用来**请求**终止一个线程 。

对一个线程调用interupt方法时，就会设置线程的中断状态。（这是一个每个线程都有的boolean标志）

- 每个线程都应该不时的检查这个标志，以判断线程是否被中断。

`Thread.currentThread.isInterrupted()方法`判断线程是否设置了中断状态。

```java
while(!Thread.currentThread().isInterrupted() && more work to do){
  do more work
}
```

如果线程被阻塞，就无法检查中断状态。

- `InterruptedException异常`：当一个被sleep或wait调用阻塞的线程上调用interrupt方法时，那个阻塞调用（sleep或wait）将被一个InterruptedException异常中断。
  - 有一些阻塞I/O不能被中断，对此应该考虑选择可中断的调用。



中断一个线程只是为了引起它的注意，**线程可以决定如何响应中断**。

1. 某些线程很重要，应该处理异常，然后继续执行。
2. 更普遍的是，线程希望将中断解释为一个终止请求。





- 

  

  

  

  

  

  

  

